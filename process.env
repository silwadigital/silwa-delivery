import { GoogleGenAI } from "@google/genai";

// Helper to safely get API Key without crashing in browser environments where 'process' is undefined
const getApiKey = (): string => {
  try {
    // Check if process.env exists (Node/Bundler env)
    if (typeof process !== 'undefined' && process.env && process.env.API_KEY) {
      return process.env.API_KEY;
    }
  } catch (e) {
    // Ignore errors accessing process
  }
  
  // In a real production app using Vite/Next.js, the env var is injected at build time.
  // For this prototype on GitHub, users should not commit keys.
  console.warn("API Key não encontrada. As funcionalidades de IA não responderão.");
  return ''; 
};

const apiKey = getApiKey();
const ai = new GoogleGenAI({ apiKey });

export const generateDishDescription = async (dishName: string, ingredients: string): Promise<string> => {
  if (!apiKey) {
    return "Descrição automática indisponível (Configure a API Key).";
  }

  try {
    const model = 'gemini-3-flash-preview';
    const prompt = `
      Atue como um copywriter gastronômico profissional para um cardápio de restaurante.
      Crie uma descrição curta, apetitosa e vendedora (máximo 160 caracteres) para um prato chamado "${dishName}".
      Ingredientes principais: ${ingredients}.
      Não use aspas na resposta.
    `;

    const response = await ai.models.generateContent({
      model: model,
      contents: prompt,
    });

    return response.text || "Delicioso prato preparado com ingredientes frescos.";
  } catch (error) {
    console.error("Gemini API Error:", error);
    return "Delicioso prato preparado com ingredientes selecionados.";
  }
};

export const generatePartnerInsight = async (stats: any): Promise<string> => {
    if (!apiKey) return "Configure sua chave de API para receber insights de IA.";

    try {
      const model = 'gemini-3-flash-preview';
      const prompt = `
        Analise estes dados de um parceiro afiliado de um sistema de delivery:
        Lojas ativas: ${stats.activeStores}.
        Comissão Pendente: R$ ${stats.pendingCommission}.
        Dê uma dica curta e motivacional de 1 frase sobre como ele pode aumentar seus ganhos indicando mais pizzarias e hamburguerias.
      `;
  
      const response = await ai.models.generateContent({
        model: model,
        contents: prompt,
      });
  
      return response.text || "Continue indicando novas lojas para aumentar sua renda recorrente!";
    } catch (error) {
      console.error("Gemini API Error:", error);
      return "Foque em trazer lojas com alto volume de vendas.";
    }
  };
